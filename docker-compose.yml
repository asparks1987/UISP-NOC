version: '3.8'

services:
  uisp-noc:
    build: .
    container_name: uisp-noc
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    environment:
      - UISP_URL=https://changeme.unmsapp.com
      - UISP_TOKEN=YOUR_API_TOKEN_HERE
      # Optional: Embedded Gotify defaults (change on first run)
      - GOTIFY_DEFAULTUSER_NAME=admin
      - GOTIFY_DEFAULTUSER_PASS=changeme
      # If you create an application in Gotify, place token here for auto-send
      # - GOTIFY_TOKEN=your_gotify_application_token
    # No direct host port exposure; Caddy will proxy 80/443
    # Uncomment to expose directly without Caddy:
    # ports:
    #   - "1200:80"
    #   - "18080:18080"  # Expose Gotify UI/API (optional)
    volumes:
      - noc_cache:/var/www/html/cache
    restart: unless-stopped

  caddy:
    image: caddy:2
    container_name: uisp-caddy
    depends_on:
      - uisp-noc
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    environment:
      # Set your public domain(s) and ACME email for real certs
      - NOC_DOMAIN=noc.example.com
      # Optional: serve embedded Gotify on its own hostname
      # - GOTIFY_DOMAIN=gotify.example.com
      # Email used for Let's Encrypt/ACME notifications
      - ACME_EMAIL=admin@example.com
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - ./web:/var/www/html/web:ro
    restart: unless-stopped

  api:
    build:
      context: ./api
    container_name: uisp-api
    environment:
      - API_ADDR=:8080
      - API_BASE_URL=http://api:8080
      - UISP_BASE_URL=http://uisp-noc
      - APP_ENV=dev
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

volumes:
  noc_cache:
  caddy_data:
  caddy_config:
